---
title: "Student Engagmement"
author: "Kelechi Ezema"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
# load packages #####
library(tidyverse)  # data processing
library(haven)      # read in stata data
library(vtable)     # summary tables
library(labelled)   # to see and create variable labels
library(lme4)      # estimate MLM
library(sjPlot)    # regression tables
library(lmerTest)  # hypothesis testing for MLM
library(quantreg)
library(blme)
library(writexl)
library(openxlsx)
library(robustlmm)
library(DescTools)
library(reshape2)
library(robustlmm)
library(visreg)
library(emmeans)
library(car)

```


## Load Data

```{r}
team_file <- read.csv(file = "april_6_team_enagement.csv")

```



## Data Filterering

```{r}
team_data <- team_file
# Select Student_Tutor_Group with participant_count >= 3 (two student and a tutor)
team_data <- team_data %>% filter(participant_count >= 3)

#Select Student_Tutor_Group with achievement score
team_data <- team_data %>% filter(is.na(I) == FALSE)

#Select Student_Tutor_Group with tutor in the session
team_data <- team_data %>% filter(is.na(utterance_proportion_tutor) == FALSE)


# Select Student_Tutor_Group with unique_session_IDs_count > 10
team_data <- team_data %>% filter(unique_session_IDs_count >= 10)


dim(team_data)
```

## Column Renaming

```{r}
team_data <- team_data %>%
  mutate(
         student_talkmove_mean_across_session = talk_move_proportion_mean_across_session_student,
         student_utterance_mean_across_session = utterance_proportion_mean_across_session_student,
         # student_learning_community_mean_across_session = learning_community_proportion_mean_across_session_student,
         # student_rigorous_thinking_mean_across_session = rigorous_thinking_proportion_mean_across_session_student,
         # student_content_knowledge_mean_across_session = content_knowledge_proportion_mean_across_session_student,
         # student_relating_mean_across_session = student_relating_proportion_mean_across_session,
         # student_asking_for_info_mean_across_session = student_asking_for_info_proportion_mean_across_session,
         # student_making_claim_mean_across_session = student_making_claim_proportion_mean_across_session,
         # student_providing_evidence_mean_across_session = student_providing_evidence_proportion_mean_across_session,
         
         student_utterance_euclidean_mean_across_session = utterance_proportion_euclidean_mean_across_session_student,
         student_talkmove_euclidean_mean_across_session = talk_move_proportion_euclidean_mean_across_session_student,
         # student_learning_community_euclidean_mean_across_session = learning_community_proportion_euclidean_mean_across_session_student,
         # student_rigorous_thinking_euclidean_mean_across_session = rigorous_thinking_proportion_euclidean_mean_across_session_student,
         # student_content_knowledge_euclidean_mean_across_session = content_knowledge_proportion_euclidean_mean_across_session_student,
         # student_relating_euclidean_mean_across_session = student_relating_proportion_euclidean_mean_across_session,
         # student_asking_for_info_euclidean_mean_across_session = student_asking_for_info_proportion_euclidean_mean_across_session,
         # student_making_claim_euclidean_mean_across_session = student_making_claim_proportion_euclidean_mean_across_session,
         # student_providing_evidence_euclidean_mean_across_session = student_providing_evidence_proportion_euclidean_mean_across_session,

         tutor_talkmove_mean_across_session = talk_move_proportion_mean_across_session_tutor,
         tutor_utterance_mean_across_session = utterance_proportion_mean_across_session_tutor,
         # tutor_learning_community_mean_across_session = learning_community_proportion_mean_across_session_tutor,
         # tutor_rigorous_thinking_mean_across_session = rigorous_thinking_proportion_mean_across_session_tutor,
         # tutor_content_knowledge_mean_across_session = content_knowledge_proportion_mean_across_session_tutor,
         # tutor_tutor_keeping_together_mean_across_session = tutor_keeping_together_proportion_mean_across_session,
         # tutor_students_relating_mean_across_session = tutor_students_relating_proportion_mean_across_session,
         # tutor_restating_mean_across_session = tutor_restating_proportion_mean_across_session,
         # tutor_revoicing_mean_across_session = tutor_revoicing_proportion_mean_across_session,
         # tutor_reasoning_mean_across_session = tutor_reasoning_proportion_mean_across_session,

         Intercept = I,
         Slope = S,

  )

```


## Rescaling Achievement Intercept and Slope

```{r}
team_data <- team_data %>%
  mutate(
         Slope = Slope *100,
         Intercept = Intercept*100
  )

```



## Histogram for predictors before winsorization
```{r}
plot_histogram <- function(df, vars, id)
{
  data.plot <- melt(df[c(id, vars)],  id = id);
  ggplot(data.plot, aes(x = value)) + geom_histogram() + facet_wrap(~variable, scales = "free")
}


vars <- c("student_talkmove_mean_across_session", "student_utterance_mean_across_session", 
          "student_utterance_euclidean_mean_across_session", "student_talkmove_euclidean_mean_across_session", 
          "tutor_talkmove_mean_across_session", "tutor_utterance_mean_across_session", "unique_session_IDs_count")

plot_histogram(team_data, vars, id = "student_tutor_id")


```







## Winzeration of Predictor variables
```{r}
#Winsorize the variables

vars <- c("student_talkmove_mean_across_session", "student_utterance_mean_across_session", 
          "student_utterance_euclidean_mean_across_session", "student_talkmove_euclidean_mean_across_session", 
          "tutor_talkmove_mean_across_session", "tutor_utterance_mean_across_session", "unique_session_IDs_count")

for (var in vars) {
  team_data[paste0(var, "_w")] <- Winsorize(team_data[[var]], quantile(team_data[[var]], probs=c(0.0, 0.99), na.rm = FALSE))
}
```




<!-- ## Cummulate Frequency Table of data   -->
<!-- ```{r} -->

<!-- freq_table <- function(x) -->
<!-- { -->
<!--   return(cbind(Freq=table(x), Cumul=cumsum(prop.table(table(x))), relative=prop.table(table(x)))); -->
<!-- } -->

<!-- # Print the frequency table in 2 decimal places -->
<!-- freq_table(round(team_data$unique_session_IDs_count_w, 1) ) -->


<!-- ``` -->


## Histogram for predictors after winsorization
```{r}
#Histogram for all the predictors
vars <- c("student_talkmove_mean_across_session_w", "student_utterance_mean_across_session_w", 
          "student_utterance_euclidean_mean_across_session_w", "student_talkmove_euclidean_mean_across_session_w", 
          "tutor_talkmove_mean_across_session_w", "tutor_utterance_mean_across_session_w", "unique_session_IDs_count_w")

plot_histogram(team_data, vars, id = "student_tutor_id")


```


## Corrlation of independent variables 

```{r}
# Select relevant variables
data <- team_data[, c("student_talkmove_mean_across_session_w",  "student_utterance_mean_across_session_w",  "student_utterance_euclidean_mean_across_session_w", "student_talkmove_euclidean_mean_across_session_w",           "tutor_talkmove_mean_across_session_w", "tutor_utterance_mean_across_session_w", "unique_session_IDs_count_w")]  

#Calculate a correlation matrix
cor_matrix <- cor(data)

tab_corr(data)
```

## MLM Modeling

### Student_Talkmove_Mean_Across_Session
```{r}
model_01 <- blmer(Slope ~ student_talkmove_mean_across_session_w + student_utterance_euclidean_mean_across_session_w + tutor_talkmove_mean_across_session_w + tutor_utterance_mean_across_session_w + unique_session_IDs_count_w +
              (1 | student_tutor_group),
              data = team_data, REML = TRUE, control = lmerControl(optimizer = "bobyqa"))


tab_model(model_01)

```



### Student_Talkmove_Euclidean_Mean_Across_Session
```{r}
model_01 <- blmer(Slope ~ student_talkmove_euclidean_mean_across_session_w + student_utterance_mean_across_session_w +  tutor_talkmove_mean_across_session_w + tutor_utterance_mean_across_session_w + unique_session_IDs_count_w +
              (1 | student_tutor_group),
              data = team_data, REML = TRUE, control = lmerControl(optimizer = "bobyqa"))


tab_model(model_01)

```

